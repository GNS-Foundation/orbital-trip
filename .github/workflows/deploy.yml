name: Deploy Orbital TrIP

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '20'

jobs:
  test:
    name: Test & Validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run healthcheck
        run: npm test

      - name: Validate catalog
        run: |
          node -e "
            const {CATALOG, STORIES} = require('./src/catalog');
            console.log('Catalog:', CATALOG.length, 'satellites');
            console.log('Stories:', Object.keys(STORIES).length);
            if (CATALOG.length < 80) { console.error('Catalog too small'); process.exit(1); }
            if (Object.keys(STORIES).length < 3) { console.error('Not enough stories'); process.exit(1); }
            console.log('✓ Catalog validated');
          "

      - name: Validate server starts
        run: |
          # Server will try to fetch CelesTrak on startup but may fail in CI
          # That's OK — it falls back gracefully. Just verify it starts.
          timeout 15 node src/server.js &
          sleep 5
          curl -sf http://localhost:3000/health | node -e "
            let d=''; process.stdin.on('data',c=>d+=c); process.stdin.on('end',()=>{
              const j=JSON.parse(d);
              console.log('Health:', j.status);
              console.log('Pipeline running:', j.pipeline.running);
              if(j.status!=='ok') process.exit(1);
              console.log('✓ Server healthy');
            })
          "

  deploy:
    name: Deploy to Railway
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4
      - name: Install Railway CLI
        run: npm install -g @railway/cli
      - name: Deploy
        run: railway up --service orbital-trip --detach
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
      - name: Verify deployment
        run: |
          echo "Waiting 90s for deployment + pipeline..."
          sleep 90
          if [ -n "${{ vars.RAILWAY_URL }}" ]; then
            curl -sf "${{ vars.RAILWAY_URL }}/health" | node -e "
              let d=''; process.stdin.on('data',c=>d+=c); process.stdin.on('end',()=>{
                const j=JSON.parse(d);
                console.log('Production:', j.status);
                console.log('Satellites:', j.data.satellites);
                console.log('Source:', j.data.source);
              })
            " || echo "Health check pending (pipeline may still be running)"
          fi
